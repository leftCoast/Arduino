#include "UI.h"
#include <adafruit_684_Obj.h>
#include <bmpPipe.h>
#include <colorObj.h>
#include <blinker.h>
#include "parameters.h"

#define OLED_CS     10
#define OLED_RST    6
#define OLED_SDCS   4

UI      ourDisplay;
blinker idleLight(13,80,2000);

// Example to use this : https://github.com/javl/image2cpp/blob/master/oled_example/oled_example.ino

// 'bomb9664', 96x64px
const unsigned char bombBitmap [] PROGMEM = {
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe7, 
  0xff, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe7, 0xff, 0x9f, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 0xff, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xf3, 0xfe, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 
  0xfc, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xef, 0xf9, 0xf8, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc3, 0xf9, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xf0, 0x7c, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x1c, 
  0xe3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x07, 0xe7, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xe1, 0xff, 0xff, 0xfc, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x3f, 0xff, 
  0x7c, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1e, 0x07, 0xfe, 0x7f, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xfe, 0x7f, 0xc0, 0xf8, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xfc, 0xff, 0xf8, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xff, 0xff, 0x07, 
  0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xf8, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xfd, 0xff, 0xff, 0xff, 0xbc, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xfd, 0xff, 0xff, 0xe7, 0x9e, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0xff, 0xff, 0xcf, 
  0xbf, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x07, 0xff, 0x8f, 0xbf, 0x8f, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0x00, 0x07, 0xff, 0x1f, 0xbf, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0x00, 0x07, 0xfe, 0x3f, 0xbf, 0xe3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x07, 0xfe, 0x7f, 
  0xbf, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x03, 0xfe, 0xff, 0xbf, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0xff, 0xff, 0xbf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
  0x00, 0x00, 0x7f, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x1f, 0xff, 
  0xbf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 
  0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x03, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xfc, 0x06, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x0e, 
  0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x1e, 0x00, 0x00, 0x00, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x1c, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xf8, 0x38, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x38, 
  0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x38, 0x00, 0x00, 0x00, 0x7f, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x38, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xf0, 0x38, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x38, 
  0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x38, 0x00, 0x00, 0x00, 0x7f, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x38, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xf8, 0x38, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x1c, 
  0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x1e, 0x00, 0x00, 0x00, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x0e, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xfc, 0x07, 0x80, 0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x07, 
  0xc0, 0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x03, 0xf0, 0x00, 0x03, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xf8, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0x80, 0x30, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 
  0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x3f, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfc, 0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x3f, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

 // flasher so far..
 
flasher::flasher(rect* inRect,colorObj* backColor)
  : drawObj(inRect),
  blinker() {

  mBackColor.setColor(backColor);   // What is "off"?
  mForeColor.setColor(&red);        // Reasonable default.
}


flasher::flasher(int inX,int inY,int inWidth,int inHeight,colorObj* backColor)
  : drawObj(inX,inY,inWidth,inHeight),
  blinker() {
  
  mBackColor.setColor(backColor);   // What is "off"?
  mForeColor.setColor(&red);        // Reasonable default.
}

                     
flasher::~flasher(void) { }


// Basically a hacked version fro blinker to remove the pinmode stuff.
// This is your on/off switch. Call with a boolean tru=on false=off.
// The object is created in the "off" mode.
void flasher::setBlink(bool onOff) {
  
 if (!init) {             // Not intialized?
    hookup();             // Set up idling.
    init = true;          // Note it.
  }
  if((onOff!=running)) {  // ignore if no change
    if (onOff) {          // Start blinking..    
      start();            // Starting NOW!
      setLight(true);     // light on!
      onTimer->start();   // set the time on timer.
      running = true;     // Set state.
      } 
    else {                // Stop blinking..
      setLight(false);    // light off.
      running = false;    // set state.
    }
  }
}   

    
void flasher::setLight(bool onOff) {

  lightOn = onOff;
  setNeedRefresh();
}


void flasher::drawSelf(void) {

  if (lightOn) {
    screen->fillRect(x,y,width,height,&mForeColor);
  } else {
    screen->fillRect(x,y,width,height,&mBackColor);
  }
}

 
// Set percent vlaues from 0..100 as a 3 char int. -1 gives "---"

percView::percView(int x,int y)
  : label(x,y,36,8,"---",2) {
  setColors(&white,&black); 
}


percView::~percView(void) { }


void percView::setPercent(float percent) {

  int   intPercent;
  char  pText[6];
  
  if (percent<0) {                         
    strcpy(pText,"---");
  } else {
    intPercent = round(percent);              // Comes in as a percent float.
    if (intPercent<10) {                      // If its 1-9..
      snprintf (pText,5,"  %d",intPercent);   // put in two spaces.
    } else if (intPercent<100) {              // Else if its less than 100..               
      snprintf (pText,5," %d",intPercent);    // One space.
    } else {                                  // Else.. (>99) 
      snprintf (pText,5,"%d",intPercent);     // No spaces.
    }
  }
  setValue(pText);
}



// *****************************************************


stateView::stateView(int x,int y) 
  : label(x,y,96-x,8,"Startup",2) {
  setColors(&white,&black);
}


stateView::~stateView(void) {  }


void  stateView::setState(weDo inState) {

  switch(inState) {
    case sitting    : setValue("Reading"); break;
    case watering   : setValue("Watering"); break;
    case soaking    : setValue("Soaking"); break;
  }
}



// *****************************************************


// Our output. If we have a screen, we use it. If not? We can flash the light.


UI::UI(void) 
  : timeObj(500) { mHaveScreen = false; }


UI::~UI(void) {  }


// We can't tell weather we have a screen or not. So we'll look for the SD drive.
void UI::begin(void) {

  hookup();
  mHaveScreen = SD.begin(OLED_SDCS);
  dataLog::begin(mHaveScreen);  // Hardware's been checked. Fire the logger up.
  if (mHaveScreen) {
    mHaveScreen = mHaveScreen && initScreen(ADAFRUIT_684,OLED_CS,OLED_RST,INV_LANDSCAPE);
    if (mHaveScreen) {
       
       mLastMoist = -1;
       mLastLimit = -1;
       mLastState = weAre;
      
      screen->fillScreen(&black);
    
      int yPos = 0;
  
      mLimit = new percView(5,yPos);
      mLimit->setPercent(mLastLimit);
      viewList.addObj(mLimit);
  
      mMoisture = new percView(53,yPos);
      mMoisture->setPercent(mLastMoist);
      viewList.addObj(mMoisture);
    
      mSlash = new label(41,yPos,96,16,"/",2);
      mSlash->setColors(&white);
      viewList.addObj(mSlash);
  
      yPos = yPos + 20;
      mKey = new label(9,yPos,96,16,"Limit/Reading",1);
      mKey->setColors(&white);
      viewList.addObj(mKey);

      mLoggingLED = new flasher(0,yPos+1,5,5);
      viewList.addObj(mLoggingLED);
      mLoggingLED->setBlink(false);
      
      yPos = yPos + 20;                      //"100/100"
      mState = new stateView(0,yPos);
      mState->setState(mLastState);
      viewList.addObj(mState);

      start();
    } 
  }
  if (!mHaveScreen) {
    pinMode(13, OUTPUT);
    idleLight.setBlink(true);                             // Start up our running light. Its all we got.
  }
}


void UI::sensorDeath(void) {

  crash = true;
  if (mHaveScreen) {
    bmpPipe bomb(rect(0,0,96,64));
    bomb.openPipe("/bomb9664.bmp");
    bomb.drawBitmap(0,0);
  }
  pinMode(13, OUTPUT);
  while(crash) {
    digitalWrite(13,HIGH);
    delay(20);
    digitalWrite(13,LOW);
    delay(100);
  }              
}


void UI::idle(void) {

  if (mHaveScreen && ding()) {
    if (moisture!=mLastMoist) {
      mMoisture->setPercent(moisture);
      mLastMoist = moisture;
    }
    if (ourParamObj.getDryLimit()!=mLastLimit) {
      mLimit->setPercent(ourParamObj.getDryLimit());
      mLastMoist = ourParamObj.getDryLimit();
    }
    if (weAre!=mLastState) {
      mState->setState(weAre);
      mLastState = weAre;
    }
    if (isLogging()!=mLoggingLED->blinking()) {        // If it don't match,
      mLoggingLED->setBlink(isLogging());             // fix it.
    }                                                 // Otherwise, leave it alone!
    start();
  }
};
